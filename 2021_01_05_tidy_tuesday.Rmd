---
title: "Tidy Tuesday: Bring Your Own Data"
date: 2021-01-2
output: html_document
---

My New Year's resolution for 2021 is to improve my data analysis and data visualization skills. To help build my skills, I decided to participate in [#TidyTuesday](https://github.com/rfordatascience/tidytuesday), a weekly data projected created by [Thomas Mock](https://thomasmock.netlify.app/) and organized by the [R4DS Online Learning Community](https://www.rfordatasci.com/). #TidyTuesday focuses on undestanding and using tidyr, dplyr, ggplot2 among others to analyze data. 

The theme for Week 1 of 2021's #TidyTuesday is Bring Your Own Data. I decided to use data from the 2021 Allstate Sugar Bowl between The Ohio State Buckeyes and the Clemson Tigers. Clemson opened as a 7.5 point favorite but Ohio State ended up winning 49 - 28. To celebrate the Buckeyes advancing to the National Championship game, today's #TidyTuesday will be about Ohio State's offensive performance against Clemson. 

```{r setup, include=FALSE}

knitr::opts_chunk$set(echo = TRUE)

library(cfbscrapR)
library(tidyverse)
library(gt)
library(espnscrapeR)
```

***
Load the required packages that are needed to analyze and visualize the data. I'm using `cfbscrapR` to access the college football statistics, `tidyverse` to clean and analyze the data, `gt` to create well-polished tables and `espnscrapeR` to access additional table themes. 

```{r Load}

library(cfbscrapR)
library(tidyverse)
library(tidytuesdayR)
library(gt)
library(espnscrapeR)
```

Once the required packages are loaded, we can begin to gather the necessary data. Since I picked the 2021 Allstate Sugar Bowl between Clemson and Ohio State, I only want data for that specific game. Using the `cfb_pbp_data()` function of the `cfbscrapR` package, we can access the play by play data. 

```{r}
sugar.pbp <- cfb_pbp_data(
  year = 2020,
  season_type = "postseason", 
  week = 1, 
  team = "Ohio State", 
  play_type = NULL, 
  epa_wpa = TRUE) #Set epa_wpa = TRUE to include epa and wpa data 
```

Next, we need to filter out garbage time and reclassify the plays. Parker Fleming detailed the process behind this in a vignette for the `cfbscrapR` package. Essentially, Garbage Time occurs when one of the following conditions is met: score difference is greater than 43 in the first quarter, 37 in the second quarter, 27 in the third quarter, or 22 in the fourth quarter. 

The `mutate()` function is used to classify the passing and rushing plays. Rushes were renamed to "Runs" and passes were renamed to "Receptions". 

```{r}
#categorize rush and passes, filter out garbage time
sugar.pbp.plays <- sugar.pbp %>%
  mutate(rush = ifelse(play_type == "Rush", 1, 0),
         pass = ifelse(pass == 1, 1, 0),
         play = case_when(rush == 1 ~ "Run",
                          pass == 1 ~ "Reception"),
         abs_diff = abs(score_diff),
         garbage = ifelse(period == 1 & abs_diff > 43, 1, 
                          ifelse(period == 2 & abs_diff > 37, 1,
                                 ifelse(period == 3 & abs_diff > 27, 1,
                                        ifelse(period == 4 & abs_diff > 22, 1, 0))))) %>% 
  filter(garbage == 0) 
```

Specifically, we want to look at Ohio State's offensive statistics. To do so, we will filter for any play where Ohio State is the offensive team. We will also remove all data that is not associated with a play. 

```{r}
#filter for only OSU offense plays 
offense.osu <- sugar.pbp.plays %>% 
  filter(offense_play == "Ohio State") %>% 
  filter(!is.na(play)) 
```

We'll select all passing plays and group them by receiver's name. The `summarize()` function allows us to create a mathematical 'summary' of the data, with functions such as `mean()` and `sum()`. I summed up the data with average yards per play, average EPA per play, the success rate, total yards and the number of plays. I use the `arrange()` function to rank the data by EPA per play 

```{r}
#create WR database 
offense.wr <- offense.osu %>% 
  mutate(player_name = receiver_player_name) %>% 
  filter(pass == 1) %>% 
  group_by(play, player_name) %>% 
  summarize(
    yards.play = mean(yards_gained),
    epa.play = mean(EPA), 
    success.rate = mean(success), 
    total.yards = sum(yards_gained),
    n = n()) %>% 
  arrange(desc(epa.play)) %>% 
  filter(!is.na(player_name))
```

The process is repeated for rushes and dropbacks. Since `cfbscrapR` doesn't separate passes thrown and pass receptions, QB passes were renamed to dropback. 

```{r}
#create RB database 
offense.rb <- offense.osu %>% 
  mutate(player_name = rusher_player_name) %>% 
  filter(rush == 1) %>% 
  group_by(play, player_name) %>% 
  summarize(
    yards.play = mean(yards_gained),
    epa.play = mean(EPA), 
    success.rate = mean(success), 
    total.yards = sum(yards_gained),
    n = n()) %>% 
  arrange(desc(epa.play)) %>% 
  filter(player_name != "TEAM")

#create QB database
offense.qb <- offense.osu %>% 
  mutate(player_name = passer_player_name) %>% 
  filter(pass == 1)

qb.name <- offense.qb %>% 
  group_by(play, player_name) %>% 
  summarize(
    yards.play = mean(yards_gained),
    epa.play = mean(EPA), 
    success.rate = mean(success), 
    total.yards = sum(yards_gained),
    n = n()) 

qb.name[1,1] = "Dropback"
```

Now we have three data frames, offense.wr, offense.rb and qb.name. All three data frames have the same column names, so we can use `rbind()` to merge the data frames together. 

```{r}
rec.offense <- rbind(offense.wr, offense.rb)
offense.data <- rbind(qb.name,rec.offense)
```

Let's check our data with the `head()` function again and see if it correctly compiled 
```{r}
head(offense.data)
```

Looks like the data has everything! It has the play type, player name and the correct statistics. I decided to organize the data into a table.

```{r}
gt(offense.data) %>% 
  tab_header(title = md("**Ohio State Offense Statistics**"),
             subtitle = ("2021 Allstate Sugar Bowl - Garbage Time Excluded")) %>% 
  tab_source_note(source_note = "Data: @CFB_Data via cfbscrapR | Figure: @juliacat_23")
```


The data looks good but the table is rather basic. I formatted the numbers so that success rate is a percentage and EPA per play, yards per play and success rate each have 2 decimal plays. The column names were renamed so the chart is more readable. 

```{r}
gt(offense.data) %>% 
  tab_header(title = md("**Ohio State Offense Statistics**"),
             subtitle = ("2021 Allstate Sugar Bowl - Garbage Time Excluded")) %>% 
  tab_source_note(source_note = "Data: @CFB_Data via cfbscrapR | Figure: @juliacat_23") %>%
  fmt_number(
    columns = vars(yards.play, epa.play),
    decimals = 2) %>% 
  fmt_percent(
    columns = vars(success.rate),
    decimals = 2) %>% 
  cols_label(
    player_name = "",
    epa.play = "EPA/Play", 
    success.rate = "Success %", 
    yards.play = "Yards/Play",
    total.yards = "Total Yards", 
    n = "Plays")
```


I added a quick footnote to explain the calculation of success rate. To finish up, the 538 theme from `espnscrapeR` package is applied and the EPA per play column is color-coded. 

```{r}
gt(offense.data) %>% 
  tab_header(title = md("**Ohio State Offense Statistics**"),
             subtitle = ("2021 Allstate Sugar Bowl - Garbage Time Excluded")) %>% 
  tab_source_note(source_note = "Data: @CFB_Data via cfbscrapR | Figure: @juliacat_23") %>%
  fmt_number(
    columns = vars(yards.play, epa.play),
    decimals = 2) %>% 
  fmt_percent(
    columns = vars(success.rate),
    decimals = 2) %>% 
  cols_label(
    player_name = "",
    epa.play = "EPA/Play", 
    success.rate = "Success %", 
    yards.play = "Yards/Play",
    total.yards = "Total Yards", 
    n = "Plays") %>% 
  tab_footnote(
    footnote = "Success is defined as 50% of necessary yardage on first down, 70% on second down, and 100% on third and fourth down.",
    locations = cells_column_labels(
      columns = vars(success.rate))) %>% 
  data_color(
    columns = vars(epa.play),
    colors = scales::col_numeric(
      palette = c("#ffffff", "#f2fbd2", "#c9ecb4", "#93d3ab", "#35b0ab"),
      domain = NULL)) %>% 
  gt_theme_538()
```

## Citations 

Fleming, P. (2020, July 5). *Introduction to College Football Analytics* CfbscrapR. 
[https://saiemgilani.github.io/cfbscrapR/articles/intro.html](https://saiemgilani.github.io/cfbscrapR/articles/intro.html)

Mock, T. (2020, May 18). *gt - a (G)rammar of (T)ables*. The Mockup Blog.  [https://themockup.blog/posts/2020-05-16-gt-a-grammer-of-tables/](https://themockup.blog/posts/2020-05-16-gt-a-grammer-of-tables/)
